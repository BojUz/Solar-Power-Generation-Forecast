<!DOCTYPE html>
<html lang="bg">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="/static/styles/style.css" rel= "stylesheet" type= "text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- <link href= "{{ url_for('static',filename='styles/style.css') }}" rel= "stylesheet" type= "text/css" /> -->
    <style> 
        /* Общ стил */

      .loader-overlay {
  position: relative;
}

.loader-overlay .overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
}

/* Въртящ кръг */
.spinner {
  border: 4px solid #e2e8f0;
  border-top: 4px solid #1e3a8a;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}





.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
}

/* Анимирана лента */
.bar {
  width: 60%;
  height: 8px;
  background: linear-gradient(90deg, #1e3a8a 0%, #3b82f6 50%, #1e3a8a 100%);
  background-size: 200% 100%;
  animation: moveBar 1.5s linear infinite;
  border-radius: 4px;
}

@keyframes moveBar {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Контейнерите да могат да държат overlay вътре */
.content {
  position: relative;
}

      #flash{

          position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
             opacity: 0.9;
            transition: opacity 0.5s ease-out;
      }




       #controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      background: #f8fafc;
      padding: 15px;
      border-bottom: 2px solid #e2e8f0;
    }
    label {
      font-weight: bold;
      color: #1e293b;
    }
    input[type="date"], input[type="range"] {
      padding: 6px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }
    input[type="range"] {
      width: 180px;
    }
    #hourLabel {
      font-weight: bold;
      color: #334155;
    }
    button {
      background: #1e3a8a;
      color: white;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #3b82f6;
    }
    /* за после като стилизирам сайта, но за сега ебава снимката с зуум
    img {
      display: block;
      max-width: 100%;
      margin: 20px auto;
      
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
      */
    input[type="date"]::before {
      content: attr(placeholder);
      color: gray;
      margin-right: 5px;
    }
    </style>
    <title>Solar power forecast </title>
    <link rel="icon" type="image/x-icon" href="static/logo3.png">
    
</head>
<body>
    <header>
        <div class="logo"><a  style="text-decoration: none; color: inherit; " href="http://127.0.0.1:5000"><img src="static/logo3.png">  Solar power forecast </a></div>
        <nav>
          <ul class="nav-links">
            <li><a href="http://127.0.0.1:5000">Home</a></li>
            <li><a href="http://127.0.0.1:5000/aboutUs">About us</a></li>
            <li><a href="http://127.0.0.1:5000/archive">Archive</a></li>
            <li><a href="http://127.0.0.1:5000/contacts">Contacts</a></li>
          </ul>
        </nav>
         {% if session.get("user_id") %}
            <a href="{{ url_for('logout') }}" class="btn">Log out</a>
        {% else %}
            <a href="http://127.0.0.1:5000/l" class="btn">Log in</a>
        {% endif %}
        
        <button class="menu-toggle" onclick="toggleMenu()">☰</button>
      </header>
      <h1> </h1>
  
    <h2>Прогноза на слънчева енергия </h2>
      <div class="box">
          <!--<img src="{{ url_for('static', filename=image_file) }}" alt="Log in to see the image">
        --><h3 style="font-weight:normal;"><span> &nbsp; &nbsp;&nbsp;Изберете дата на която ще се визуализира облачното покрите и да се покаже прогноза за производството на електрическа енергия от соларни панели. </span></h3>

          <div id="controls">
  <label>
  Дата:
  <input type="text" id="datePicker" readonly>
</label>

  <label>
    Час:
    <input type="range" id="hourSlider" min="0" max="23" value="18" step="3">
    <span id="hourLabel">18:00</span>
    
  </label>
   <div class="switcher">
        <button onclick="showContent('chart')">Графика</button>
        <button onclick="showContent('table')">Таблица</button>
      </div>
</div>
<div class="flex">

    
<div id="imageContainer" style="width: 100% ; height: auto;">
  <p id="loadingMessage" style="display:none;">Зареждане...</p>
  <img id="resultImage" style="width:100%; height:auto ; display:none;  ">
</div>

       
         
        <div id="chart" class="content">
  
  <div id="chartLoading" class="loading-overlay" style="display:none;">
    <div class="bar"></div>
  </div>
  <canvas id="chart1" width="400" height="200"></canvas>
  <h4>X- Часове, Y- Прогнозирано производство</h4>
  <a onclick="downloadCSV()"><button>Свали CSV</button></a>
</div>

<div id="table" class="content active">
  <h3>Прогнозирани стойности по часове</h3>
  <div id="tableLoading" class="loading-overlay" style="display:none;">
    <div class="bar"></div>
  </div>
  <table border="1">
    <thead>
      <tr><th>Час</th><th>Произведена енергия</th></tr>
    </thead>
    <tbody id="valuesTable"></tbody>
  </table>
  <button onclick="downloadCSV()">Свали CSV</button>
</div>
</div>

  <div id="zoomContainer" style=" min-width: 610px;
      width: 100% -40px; height:400px; overflow:hidden; position:relative; border:1px solid #ccc; background-color: rgb(20, 20, 20); margin-top: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);margin-left:-20px;margin-right:-20px;" >
  <div id="zoomImage"   style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%) scale(1); user-select:none; cursor:grab;">
  <div style="position: relative; display: inline-block;">
  <!-- Основното изображение -->
  <img id="weatherImage" src="" alt="Weather Image" style="display: block;">

  <!-- Малката картинка като overlay -->
  <img id="overlayImage" src="../static/bgOutline.png" 
       style="
         position: absolute;
         bottom: 42px;
         right: 27px;
         width: 180px;  
         height: 122px;

       ">
</div>
</div>
    </div>
      </div>
    
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="messages" id="flash">
          {% for category, message in messages %}
            <div class="alert {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <footer> 2025 Solar Power Forecast</footer>
            
      <script>

function toggleMenu() {
  const nav = document.querySelector(".nav-links");
  nav.classList.toggle("active");
}


document.addEventListener("DOMContentLoaded", function () {
  flatpickr("#datePicker", {
    dateFormat: "Y-m-d",       // това ще се показва на потребителя
    defaultDate: "today",  // днешна дата
    minDate: "2024-06-23", // от 2024
    maxDate: new Date().fp_incr(1) // днес + 1 дни
  });
});



        const dateInput = document.getElementById("datePicker");
        dateInput.min = "2024-06-23";

  // максимална дата – днес + 5 дни
        const today = new Date();
        const maxDate = new Date();
        maxDate.setDate(today.getDate() + 1);

        const padi = (n) => n.toString().padStart(2, "0");
        dateInput.max = `${maxDate.getFullYear()}-${padi(maxDate.getMonth() + 1)}-${padi(maxDate.getDate())}`;

        // стойност по подразбиране – днешната дата
        dateInput.value = `${today.getFullYear()}-${padi(today.getMonth() + 1)}-${padi(today.getDate())}`;


        // Форматираме като yyyy-mm-dd
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // месеците са 0-индексирани
        const dd = String(today.getDate()).padStart(2, '0');

        dateInput.value = `${yyyy}-${mm}-${dd}`;


        function showContent(id) {
          document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
          document.getElementById(id).classList.add('active');
        }




        let chartInstance = null; // за да пазим последния chart

function fetchWithTimeout(resource, options = {}) {
  const { timeout = 10000 } = options; // 10 секунди по default

  return Promise.race([
    fetch(resource, options),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error("timeout")), timeout)
    )
  ]);
}

function updateTable() {
  const date1 = document.getElementById("datePicker").value;
  // Деактивираме input-ите

  datePicker.disabled = true;

  hourSlider.disabled = true;
  // показваме overlay-и
  document.getElementById("tableLoading").style.display = "flex";
  document.getElementById("chartLoading").style.display = "flex";

  // чистим старите данни
  document.getElementById("valuesTable").innerHTML = "";
  if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
  }

  fetch(`/get-values?date=${date1}`)
    .then(r => r.json())
    .then(data => {
      // попълваме таблицата
      let tbody = document.getElementById("valuesTable");
      for (let time in data) {
        tbody.innerHTML += `<tr><td>${time}</td><td>${data[time]} MW/h </td></tr>`;
      }

      // попълваме chart-а
      let ctx = document.getElementById("chart1").getContext("2d");
      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: Object.keys(data),
          datasets: [{
            label: "Стойности",
            data: Object.values(data),
            borderColor: "blue",
            fill: false
          }]
        }
      });
    })
    .catch(err => {
      console.error("Грешка при fetch:", err);
      document.getElementById("valuesTable").innerHTML =
        `<tr><td colspan="2">Error loading data</td></tr>`;
    })
    .finally(() => {
      // скриваме overlay-ите
      document.getElementById("tableLoading").style.display = "none";
      document.getElementById("chartLoading").style.display = "none";
      
      datePicker.disabled = false;
      hourSlider.disabled = false;
    });
}
        const flashes = document.getElementById("flash");



function downloadCSV() {
  const date = document.getElementById("datePicker").value;
  if (!date) return alert("Моля изберете дата!");

  fetch(`/download-csv?date=${date}`)
    .then(response => response.blob())
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `forecast_${date}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    })
    .catch(err => console.error(err));
}

function pad(n) { return (Number(n) < 10 ? "0" + Number(n) : String(n)); }

function updateImage() {
  const dateInput = document.getElementById("datePicker").value; // yyyy-mm-dd
  const hour = parseInt(document.getElementById("hourSlider").value);
  datePicker.disabled = true;

  hourSlider.disabled = true;
  // Връщаме 3 часа назад
  let targetDate = new Date(dateInput + "T" + pad(hour) + ":00:00");
  targetDate.setHours(targetDate.getHours() - 3);

  const yyyy = targetDate.getFullYear();
  const mm = pad(targetDate.getMonth() + 1);
  const dd = pad(targetDate.getDate());
  const hourStr = "hour_" + pad(targetDate.getHours());
  const dateCompact = yyyy + mm + dd;
  const hourCompact = pad(targetDate.getHours());

  const url = `https://data.ventusky.com/${yyyy}/${mm}/${dd}/aladin/whole_world/${hourStr}/aladin_oblacnost_${dateCompact}_${hourCompact}.jpg`;


  document.getElementById("weatherImage").src = url;

  document.getElementById("hourLabel").textContent = `${pad(hour)}:00`;

  /**888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888*/
  const date = document.getElementById("datePicker").value; // YYYY-MM-DD
  const hour1 = document.getElementById("hourSlider").value.padStart(2, '0');

  const loading = document.getElementById("loadingMessage");
  const img = document.getElementById("resultImage");

  loading.style.display = "block";
  img.style.display = "none";

  fetch(`/get_picture?date=${date}&hour=${hour1}`)
    .then(r => r.json())
    .then(data => {
      if (data.status === "ready") {
        img.src = `/results/${data.filename}?t=${Date.now()}`; // добавяме timestamp за да не кешира
        img.style.display = "block";
        loading.style.display = "none";
      } else {
        loading.textContent = "Error loading image";
      }
    });
    datePicker.disabled = false;

  hourSlider.disabled = false;
}


document.getElementById("datePicker").addEventListener("change", updateImage);
document.getElementById("hourSlider").addEventListener("input", updateImage);

document.getElementById("datePicker").addEventListener("change", updateTable);
// Първоначално зареждане
updateImage();
updateTable();


const container = document.getElementById("zoomContainer");
const img = document.getElementById("zoomImage");

let scale = 1;
let posX = 0;
let posY = 0;
let isDragging = false;
let startX, startY;

function updateTransform() {
    img.style.transform = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;
}

// Drag
img.addEventListener("mousedown", e => {
    isDragging = true;
    startX = e.clientX - posX;
    startY = e.clientY - posY;
    img.style.cursor = "grabbing";
});
window.addEventListener("mousemove", e => {
    if (!isDragging) return;
    posX = e.clientX - startX;
    posY = e.clientY - startY;
    updateTransform();
});
window.addEventListener("mouseup", () => {
    isDragging = false;
    img.style.cursor = "grab";
});

// Zoom спрямо центъра на контейнера
container.addEventListener("wheel", e => {
    e.preventDefault();
    const zoomStep = 0.1;
    const prevScale = scale;
    scale += e.deltaY < 0 ? zoomStep : -zoomStep;
    scale = Math.min(Math.max(0.5, scale), 5);

    // Запазваме позицията на изображението при zoom
    posX = posX * (scale / prevScale);
    posY = posY * (scale / prevScale);

    updateTransform();
});

// prevent default drag
img.ondragstart = () => false;


        if (flash) {
    setTimeout(() => {
        flash.style.opacity = "0";
        setTimeout(() => flash.remove(), 500);
    }, 3000);
}
      </script>
</body>
</html>