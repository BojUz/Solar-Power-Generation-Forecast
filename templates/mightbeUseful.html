<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="/static/styles/style.css" rel= "stylesheet" type= "text/css" />
    <!-- <link href= "{{ url_for('static',filename='styles/style.css') }}" rel= "stylesheet" type= "text/css" /> -->
    <style> 
        /* Общ стил */

      #flash{

          position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
             opacity: 0.9;
            transition: opacity 0.5s ease-out;
      }




       #controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      background: #f8fafc;
      padding: 15px;
      border-bottom: 2px solid #e2e8f0;
    }
    label {
      font-weight: bold;
      color: #1e293b;
    }
    input[type="date"], input[type="range"] {
      padding: 6px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }
    input[type="range"] {
      width: 180px;
    }
    #hourLabel {
      font-weight: bold;
      color: #334155;
    }
    button {
      background: #1e3a8a;
      color: white;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #3b82f6;
    }
    img {
      display: block;
      max-width: 100%;
      margin: 20px auto;
      border: 3px solid #1e3a8a;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    </style>
    <title>Solar power forecast </title>
    <link rel="icon" type="image/x-icon" href="static/logo.png">
    
</head>
<body>
    <header>
        <div class="logo"><img src="static/logo.png">  Solar power forecast </div>
        <nav>
          <ul class="nav-links">
            <li><a href="http://127.0.0.1:5000">Home</a></li>
            <li><a href="http://127.0.0.1:5000/aboutUs">About us</a></li>
            <li><a href="http://127.0.0.1:5000/archive">Archive</a></li>
            <li><a href="http://127.0.0.1:5000/contacts">Contacts</a></li>
          </ul>
        </nav>
         {% if session.get("user_id") %}
            <a href="{{ url_for('logout') }}" class="btn">Log out</a>
        {% else %}
            <a href="http://127.0.0.1:5000/l" class="btn">Log in</a>
        {% endif %}
        
      </header>
      <h1> </h1>
    <div class="switcher">
        <button onclick="showContent('image')">Pic</button>
        <button onclick="showContent('chart')">Chart</button>
        <button onclick="showContent('table')">Table</button>
      </div>
    
      <div class="box">
        <div id="image" class="content active">
          <img src="{{ url_for('static', filename=image_file) }}" alt="Log in to see the image">
          

          <div id="controls">
  <label>
    Дата:
    <input type="date" id="datePicker" value="2025-09-01">
  </label>

  <label>
    Час:
    <input type="range" id="hourSlider" min="0" max="23" value="18" step="1">
    <span id="hourLabel">18:00</span>
    
  </label>
  <div id="print"></div>
  <p id="imageUrl"></p>
</div>

<div>
  <img id="weatherImage" src="" alt="Weather Image">
</div>
        </div>
        <div id="chart" class="content">
          
          <h1>Стойности на всеки 3 часа</h1>

    <canvas id="chart1" width="400" height="200"></canvas>
    <a href="/download-csv"><button>Свали CSV</button></a>
        </div>
        <div id="table" class="content">
           <h1>Стойности от 6:00 до 18:00</h1>
    <table border="1">
        <thead>
            <tr><th>Час</th><th>Стойност</th></tr>
        </thead>
        <tbody id="valuesTable"></tbody>
    </table>
      <a href="/download-csv"><button>Свали CSV</button></a>
        </div>
      </div>
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="messages" id="flash">
          {% for category, message in messages %}
            <div class="alert {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
     <div id="debugBox" 
       style="background:#111; color:#0f0; font-family:monospace; padding:10px; margin-top:20px; max-height:200px; overflow-y:auto;">
    <strong>Debug output:</strong><br>
  </div>
      <div class="map">
        <!-- Tooltip -->
        <div class="tooltip">Hover over me
            <span class="tooltiptext">Tooltip text</span>
          
      
        <!-- SVG карта (тук е силно опростена – само 3 области) -->
        <svg viewBox="0 0 225 225">
            
          <path id="sofia" class="region" d="M10,10 L80,10 L80,40 L10,40 Z" />
          <path id="plovdiv" class="region" d="M90,20 L150,20 L150,50 L90,50 Z" />
          <path id="varna" class="region" d="M60,60 L130,60 L130,90 L60,90 Z" />
          </svg>
    </div>
      </div>
      
      
      <script>
        function showContent(id) {
          document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
          document.getElementById(id).classList.add('active');
        }


// Данни от бекенд (примерни)
const backendData = {
    sofia: { name: "София", value: 12345 },
    plovdiv: { name: "Пловдив", value: 6789 },
    varna: { name: "Варна", value: 4321 }
  };

  const tooltip = document.getElementById("tooltip");

  document.querySelectorAll(".region").forEach(region => {
    region.addEventListener("mousemove", e => {
      const data = backendData[region.id];
      tooltip.innerHTML = `${data.name}<br>Number: ${data.value}`;
      tooltip.style.left = (e.pageX + 10) + "px";
      tooltip.style.top = (e.pageY + 10) + "px";
      tooltip.style.opacity = 1;
    });
    region.addEventListener("mouseleave", () => {
      tooltip.style.opacity = 0;
    });
  });



  fetch("/get-values")
            .then(r => r.json())
            .then(data => {
                let tbody = document.getElementById("valuesTable");
                tbody.innerHTML = "";
                for (let time in data) {
                    tbody.innerHTML += `<tr><td>${time}</td><td>${data[time]}</td></tr>`;
                }
            });

  fetch("/get-values")
        .then(r => r.json())
        .then(data => {
            let ctx = document.getElementById("chart1").getContext("2d");
            new Chart(ctx, {
                type: "line",
                data: {
                    labels: Object.keys(data), // часовете
                    datasets: [{
                        label: "Стойности",
                        data: Object.values(data), // стойностите
                        borderColor: "blue",
                        fill: false
                    }]
                }
            });
        });


        const flashes = document.getElementById("flash");



function pad(n) { return (Number(n) < 10 ? "0" + Number(n) : String(n)); }
/*
function updateImage() {
  const dateInput = document.getElementById("datePicker").value; // yyyy-mm-dd
  const hour = parseInt(document.getElementById("hourSlider").value);

  // Връщаме 3 часа назад
  let targetDate = new Date(dateInput + "T" + pad(hour) + ":00:00");
  targetDate.setHours(targetDate.getHours() - 3);

  const yyyy = targetDate.getFullYear();
  const mm = pad(targetDate.getMonth() + 1);
  const dd = pad(targetDate.getDate());
  const hourStr = "hour_" + pad(targetDate.getHours());
  const dateCompact = yyyy + mm + dd;
  const hourCompact = pad(targetDate.getHours());

  const url = `https://data.ventusky.com/${yyyy}/${mm}/${dd}/aladin/whole_world/${hourStr}/aladin_oblacnost_${dateCompact}_${hourCompact}.jpg`;


  document.getElementById("weatherImage").src = url;
  document.getElementById("print").textContent = url;
  document.getElementById("hourLabel").textContent = `${pad(hour)}:00 (показва ${pad(targetDate.getHours())}:00)`;
}

*/
function updateImage() {
  const dateInput = document.getElementById("datePicker").value;
  const rawHour = document.getElementById("hourSlider").value;
  const hour = Number(rawHour);

  if (!dateInput || isNaN(hour)) {
    console.error("Липсва дата или час:", dateInput, rawHour);
    return;
  }

  // Създаваме Date обект от избраната дата и час
  const iso = `${dateInput}T${pad(hour)}:00:00`;
  let targetDate = new Date(iso);
  if (isNaN(targetDate)) {
    console.error("Невалидна дата от iso:", iso);
    return;
  }

  // Отместваме -3 часа
  targetDate.setHours(targetDate.getHours() - 3);

  // Форматиране на стойности за етикета
  const shownHourStr = `${pad(hour)}:00`;
  const targetHourStr = `${pad(targetDate.getHours())}:00`;
  const labelText = `${shownHourStr} (показва ${targetHourStr})`;

  const hourLabelEl = document.getElementById("hourLabel");
  if (hourLabelEl) {
    hourLabelEl.textContent = labelText;
  }

  // Форматиране за URL
  const yyyy = targetDate.getFullYear();
  const mm = pad(targetDate.getMonth() + 1);
  const dd = pad(targetDate.getDate());
  const hh = pad(targetDate.getHours());

  const url = `https://data.ventusky.com/${yyyy}/${mm}/${dd}/aladin/whole_world/hour_${hh}/aladin_oblacnost_${yyyy}${mm}${dd}_${hh}.jpg`;

  // Лог за дебъг
  console.log("ISO input:", iso);
  console.log("Target date:", targetDate);
  console.log("Image URL:", url);

  // Визуализация на URL
  const urlEl = document.getElementById("imageUrl");
  if (urlEl) {
    urlEl.textContent = url;
  }

  // Сменяме картинката
  const imgEl = document.getElementById("weatherImage");
  if (imgEl) {
    imgEl.src = url;
    imgEl.alt = `Облачност за ${dd}/${mm}/${yyyy} ${hh}:00`;
  }
}

  function debugLog(msg) {
      console.log(msg); // нормално в конзолата
      let box = document.getElementById("debugBox");
      box.innerHTML += msg + "<br>";
      box.scrollTop = box.scrollHeight; // винаги да скролва надолу
    }

    // Пример:
    let testUrl = "https://example.com/image.jpg";
    debugLog("Image URL: " + testUrl);
// Event listeners
document.getElementById("datePicker").addEventListener("change", updateImage);
document.getElementById("hourSlider").addEventListener("input", updateImage);

// Първоначално зареждане
updateImage();


        if (flash) {
    setTimeout(() => {
        flash.style.opacity = "0";
        setTimeout(() => flash.remove(), 500);
    }, 3000);
}
      </script>
</body>
</html>